{"version":3,"file":"statement.min.js","sources":["../src/statement.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Bulk actions for lists of participants.\n *\n * @module     local_integrity/statement\n * @copyright  2021 Catalyst IT\n * @author     Dmitrii Metelkin (dmitriim@catalyst-au.net)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport KeyCodes from 'core/key_codes';\n\n/**\n * Initialising of the module.\n *\n * @param {Integer} contextid Context ID,\n * @param {String} statementname\n * @param {String} cancelurl URL to redirect if cancelled.\n * @param {String} agreeurl URL to redirect if agrred.\n */\nfunction init(contextid, statementname, cancelurl, agreeurl = '') {\n    self.contextid = contextid;\n    self.statementname = statementname;\n    self.cancelurl = cancelurl;\n    self.submitted = false;\n    self.agreeurl = agreeurl;\n\n    document.addEventListener('keyup', escCloseListener);\n\n    let noticeRequest = {\n        methodname: 'local_integrity_get_statement_notice',\n        args: {'name': statementname}\n    };\n\n    Ajax.call([noticeRequest])[0].done(function(data) {\n\n        let strings = [\n            {key: 'statement:header', component: 'local_integrity'},\n            {key: 'statement:save', component: 'local_integrity'},\n            {key: 'statement:cancel', component: 'local_integrity'}\n        ];\n\n        Str.get_strings(strings).then(function(langStrings) {\n            let templateContext = {\n                notice: data.notice,\n            };\n\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: Templates.render('local_integrity/statement_form', templateContext),\n                title: langStrings[0],\n                buttons: {\n                    save: langStrings[1],\n                    cancel: langStrings[2]\n                },\n                removeOnClose: true,\n                isLarge: true,\n            });\n        }).then(function(modal) {\n            modal.getRoot().on(ModalEvents.save, (e) => agreeStatement(e, modal));\n            modal.getRoot().on(ModalEvents.destroyed, () => handleCancelRedirect());\n            modal.getRoot().on(ModalEvents.hidden, () => handleCancelRedirect());\n            modal.getRoot().on(ModalEvents.cancel, () => handleCancelRedirect());\n\n            modal.show();\n        }).catch(Notification.exception);\n    }).fail(Notification.exception);\n}\n\n/**\n * Listen to escape button pushed.\n * @param {Event} e\n */\nfunction escCloseListener(e) {\n    if (e.keyCode === KeyCodes.escape) {\n        handleCancelRedirect();\n    }\n}\n\n/**\n * Handle redirect if canceled.\n */\nfunction handleCancelRedirect() {\n    if (self.submitted === false) {\n        window.location.replace(self.cancelurl);\n    }\n}\n\n/**\n * Handle redirect if agreed.\n */\nfunction handleAgreeRedirect() {\n    if (self.agreeurl !== '') {\n        window.location.replace(self.agreeurl);\n    }\n}\n\n/**\n * Submit statement agreement.\n *\n * @param {Event} e\n * @param {Modal} modal\n */\nfunction agreeStatement(e, modal) {\n    const agreed = modal.getRoot().find('form input').prop('checked');\n\n    e.preventDefault();\n\n    if (agreed === false) {\n        modal.getRoot().find('[data-role=\"agreementrequired\"]').removeAttr('hidden');\n        return;\n    }\n\n    const args = {\n        'name': self.statementname,\n        'contextid': self.contextid,\n        'userid': 0,\n    };\n\n    Ajax.call([{\n        methodname: 'local_integrity_agree_statement',\n        args: args,\n        done: function () {\n            self.submitted = true;\n            document.removeEventListener('keyup', escCloseListener);\n            modal.destroy();\n            handleAgreeRedirect();\n        },\n        fail: function (response) {\n            Notification.exception(response);\n        }\n    }]);\n}\n\nexport {init};\n"],"names":["escCloseListener","e","keyCode","KeyCodes","escape","handleCancelRedirect","self","submitted","window","location","replace","cancelurl","agreeStatement","modal","agreed","getRoot","find","prop","preventDefault","removeAttr","args","statementname","contextid","call","methodname","done","document","removeEventListener","destroy","agreeurl","fail","response","exception","addEventListener","noticeRequest","data","Str","get_strings","key","component","then","langStrings","templateContext","notice","ModalFactory","create","type","types","SAVE_CANCEL","body","Templates","render","title","buttons","save","cancel","removeOnClose","isLarge","on","ModalEvents","destroyed","hidden","show","catch","Notification"],"mappings":"knBA6FSA,iBAAiBC,GAClBA,EAAEC,UAAYC,mBAASC,QACvBC,gCAOCA,wBACkB,IAAnBC,KAAKC,WACLC,OAAOC,SAASC,QAAQJ,KAAKK,oBAmB5BC,eAAeX,EAAGY,aACjBC,OAASD,MAAME,UAAUC,KAAK,cAAcC,KAAK,cAEvDhB,EAAEiB,kBAEa,IAAXJ,mBACAD,MAAME,UAAUC,KAAK,mCAAmCG,WAAW,gBAIjEC,KAAO,MACDd,KAAKe,wBACAf,KAAKgB,iBACR,iBAGTC,KAAK,CAAC,CACPC,WAAY,kCACZJ,KAAMA,KACNK,KAAM,WACFnB,KAAKC,WAAY,EACjBmB,SAASC,oBAAoB,QAAS3B,kBACtCa,MAAMe,UAjCQ,KAAlBtB,KAAKuB,UACLrB,OAAOC,SAASC,QAAQJ,KAAKuB,WAmC7BC,KAAM,SAAUC,gCACCC,UAAUD;;;;;;;;;SA7GrBT,UAAWD,cAAeV,eAAWkB,gEAAW,GAC1DvB,KAAKgB,UAAYA,UACjBhB,KAAKe,cAAgBA,cACrBf,KAAKK,UAAYA,UACjBL,KAAKC,WAAY,EACjBD,KAAKuB,SAAWA,SAEhBH,SAASO,iBAAiB,QAASjC,sBAE/BkC,cAAgB,CAChBV,WAAY,uCACZJ,KAAM,MAASC,8BAGdE,KAAK,CAACW,gBAAgB,GAAGT,MAAK,SAASU,MAQxCC,IAAIC,YANU,CACV,CAACC,IAAK,mBAAoBC,UAAW,mBACrC,CAACD,IAAK,iBAAkBC,UAAW,mBACnC,CAACD,IAAK,mBAAoBC,UAAW,qBAGhBC,MAAK,SAASC,iBAC/BC,gBAAkB,CAClBC,OAAQR,KAAKQ,eAGVC,uBAAaC,OAAO,CACvBC,KAAMF,uBAAaG,MAAMC,YACzBC,KAAMC,mBAAUC,OAAO,iCAAkCT,iBACzDU,MAAOX,YAAY,GACnBY,QAAS,CACLC,KAAMb,YAAY,GAClBc,OAAQd,YAAY,IAExBe,eAAe,EACfC,SAAS,OAEdjB,MAAK,SAAS3B,OACbA,MAAME,UAAU2C,GAAGC,sBAAYL,MAAOrD,GAAMW,eAAeX,EAAGY,SAC9DA,MAAME,UAAU2C,GAAGC,sBAAYC,WAAW,IAAMvD,yBAChDQ,MAAME,UAAU2C,GAAGC,sBAAYE,QAAQ,IAAMxD,yBAC7CQ,MAAME,UAAU2C,GAAGC,sBAAYJ,QAAQ,IAAMlD,yBAE7CQ,MAAMiD,UACPC,MAAMC,sBAAahC,cACvBF,KAAKkC,sBAAahC"}