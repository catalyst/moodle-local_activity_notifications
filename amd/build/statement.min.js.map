{"version":3,"file":"statement.min.js","sources":["../src/statement.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Bulk actions for lists of participants.\n *\n * @module     local_integrity/statement\n * @copyright  2021 Catalyst IT\n * @author     Dmitrii Metelkin (dmitriim@catalyst-au.net)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport KeyCodes from 'core/key_codes';\n\n/**\n * Initialising of the module.\n *\n * @param {Integer} contextid Context ID,\n * @param {String} statementname\n * @param {String} cancelurl URL to redirect if cancelled.\n */\nfunction init(contextid, statementname, cancelurl) {\n\n    self.contextid = contextid;\n    self.statementname = statementname;\n    self.cancelurl = cancelurl;\n    self.submitted = false;\n\n    document.addEventListener('keyup', escCloseListener);\n\n    let noticeRequest = {\n        methodname: 'local_integrity_get_statement_notice',\n        args: {'name': statementname}\n    };\n\n    Ajax.call([noticeRequest])[0].done(function(data) {\n\n        let strings = [\n            {key: 'statement:header', component: 'local_integrity'},\n            {key: 'statement:save', component: 'local_integrity'},\n            {key: 'statement:cancel', component: 'local_integrity'}\n        ];\n\n        Str.get_strings(strings).then(function(langStrings) {\n            let templateContext = {\n                notice: data.notice,\n            };\n\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: Templates.render('local_integrity/statement_form', templateContext),\n                title: langStrings[0],\n                buttons: {\n                    save: langStrings[1],\n                    cancel: langStrings[2]\n                },\n                removeOnClose: true,\n                isLarge: true,\n            });\n        }).then(function(modal) {\n            modal.getRoot().on(ModalEvents.save, (e) => agreeStatement(e, modal));\n            modal.getRoot().on(ModalEvents.destroyed, () => handleRedirect());\n            modal.getRoot().on(ModalEvents.hidden, () => handleRedirect());\n            modal.getRoot().on(ModalEvents.cancel, () => handleRedirect());\n\n            modal.show();\n        }).catch(Notification.exception);\n    }).fail(Notification.exception);\n}\n\n/**\n * Listen to escape button pushed.\n * @param {Event} e\n */\nfunction escCloseListener(e) {\n    if (e.keyCode === KeyCodes.escape) {\n        handleRedirect();\n    }\n}\n\n/**\n * Handle redirect action.\n */\nfunction handleRedirect() {\n    if (self.submitted === false) {\n        window.location.replace(self.cancelurl);\n    }\n}\n\n/**\n * Submit statement agreement.\n *\n * @param {Event} e\n * @param {Modal} modal\n */\nfunction agreeStatement(e, modal) {\n    const agreed = modal.getRoot().find('form input').prop('checked');\n\n    e.preventDefault();\n\n    if (agreed === false) {\n        modal.getRoot().find('[data-role=\"agreementrequired\"]').removeAttr('hidden');\n        return;\n    }\n\n    const args = {\n        'name': self.statementname,\n        'contextid': self.contextid,\n        'userid': 0,\n    };\n\n    Ajax.call([{\n        methodname: 'local_integrity_agree_statement',\n        args: args,\n        done: function () {\n            self.submitted = true;\n            document.removeEventListener('keyup', escCloseListener);\n            modal.destroy();\n        },\n        fail: function (response) {\n            Notification.exception(response);\n        }\n    }]);\n}\n\nexport {init};\n"],"names":["escCloseListener","e","keyCode","KeyCodes","escape","handleRedirect","self","submitted","window","location","replace","cancelurl","contextid","statementname","document","addEventListener","noticeRequest","methodname","args","call","done","data","Str","get_strings","key","component","then","langStrings","templateContext","notice","ModalFactory","create","type","types","SAVE_CANCEL","body","Templates","render","title","buttons","save","cancel","removeOnClose","isLarge","modal","getRoot","on","ModalEvents","agreed","find","prop","preventDefault","removeAttr","removeEventListener","destroy","fail","response","exception","agreeStatement","destroyed","hidden","show","catch","Notification"],"mappings":"knBA4FSA,iBAAiBC,GAClBA,EAAEC,UAAYC,mBAASC,QACvBC,0BAOCA,kBACkB,IAAnBC,KAAKC,WACLC,OAAOC,SAASC,QAAQJ,KAAKK;;;;;;;;;SAhEvBC,UAAWC,cAAeF,WAEpCL,KAAKM,UAAYA,UACjBN,KAAKO,cAAgBA,cACrBP,KAAKK,UAAYA,UACjBL,KAAKC,WAAY,EAEjBO,SAASC,iBAAiB,QAASf,sBAE/BgB,cAAgB,CAChBC,WAAY,uCACZC,KAAM,MAASL,8BAGdM,KAAK,CAACH,gBAAgB,GAAGI,MAAK,SAASC,MAQxCC,IAAIC,YANU,CACV,CAACC,IAAK,mBAAoBC,UAAW,mBACrC,CAACD,IAAK,iBAAkBC,UAAW,mBACnC,CAACD,IAAK,mBAAoBC,UAAW,qBAGhBC,MAAK,SAASC,iBAC/BC,gBAAkB,CAClBC,OAAQR,KAAKQ,eAGVC,uBAAaC,OAAO,CACvBC,KAAMF,uBAAaG,MAAMC,YACzBC,KAAMC,mBAAUC,OAAO,iCAAkCT,iBACzDU,MAAOX,YAAY,GACnBY,QAAS,CACLC,KAAMb,YAAY,GAClBc,OAAQd,YAAY,IAExBe,eAAe,EACfC,SAAS,OAEdjB,MAAK,SAASkB,OACbA,MAAMC,UAAUC,GAAGC,sBAAYP,MAAOvC,YAmC1BA,EAAG2C,aACjBI,OAASJ,MAAMC,UAAUI,KAAK,cAAcC,KAAK,cAEvDjD,EAAEkD,kBAEa,IAAXH,mBACAJ,MAAMC,UAAUI,KAAK,mCAAmCG,WAAW,gBAIjElC,KAAO,MACDZ,KAAKO,wBACAP,KAAKM,iBACR,iBAGTO,KAAK,CAAC,CACPF,WAAY,kCACZC,KAAMA,KACNE,KAAM,WACFd,KAAKC,WAAY,EACjBO,SAASuC,oBAAoB,QAASrD,kBACtC4C,MAAMU,WAEVC,KAAM,SAAUC,gCACCC,UAAUD,cA5DqBE,CAAezD,EAAG2C,SAC9DA,MAAMC,UAAUC,GAAGC,sBAAYY,WAAW,IAAMtD,mBAChDuC,MAAMC,UAAUC,GAAGC,sBAAYa,QAAQ,IAAMvD,mBAC7CuC,MAAMC,UAAUC,GAAGC,sBAAYN,QAAQ,IAAMpC,mBAE7CuC,MAAMiB,UACPC,MAAMC,sBAAaN,cACvBF,KAAKQ,sBAAaN"}