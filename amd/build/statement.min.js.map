{"version":3,"sources":["../src/statement.js"],"names":["init","contextid","statementname","cancelurl","self","submitted","document","addEventListener","escCloseListener","Ajax","call","methodname","args","done","data","Str","get_strings","key","component","then","langStrings","templateContext","notice","ModalFactory","create","type","types","SAVE_CANCEL","body","Templates","render","title","buttons","save","cancel","removeOnClose","isLarge","modal","getRoot","on","ModalEvents","e","agreeStatement","destroyed","handleRedirect","hidden","show","catch","Notification","exception","fail","keyCode","KeyCodes","escape","window","location","replace","agreed","find","prop","preventDefault","removeAttr","removeEventListener","destroy","response"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Bulk actions for lists of participants.\n *\n * @module     local_integrity/statement\n * @package    local_integrity\n * @copyright  2021 Catalyst IT\n * @author     Dmitrii Metelkin (dmitriim@catalyst-au.net)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\nimport Ajax from 'core/ajax';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport KeyCodes from 'core/key_codes';\n\n/**\n * Initialising of the module.\n *\n * @param {Integer} contextid Context ID,\n * @param {String} statementname\n * @param {String} cancelurl URL to redirect if cancelled.\n */\nfunction init(contextid, statementname, cancelurl) {\n\n    self.contextid = contextid;\n    self.statementname = statementname;\n    self.cancelurl = cancelurl;\n    self.submitted = false;\n\n    document.addEventListener('keyup', escCloseListener);\n\n    let noticeRequest = {\n        methodname: 'local_integrity_get_statement_notice',\n        args: {'name': statementname}\n    };\n\n    Ajax.call([noticeRequest])[0].done(function(data) {\n\n        let strings = [\n            {key: 'statement:header', component: 'local_integrity'},\n            {key: 'statement:save', component: 'local_integrity'},\n            {key: 'statement:cancel', component: 'local_integrity'}\n        ];\n\n        Str.get_strings(strings).then(function(langStrings) {\n            let templateContext = {\n                notice: data.notice,\n            };\n\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: Templates.render('local_integrity/statement_form', templateContext),\n                title: langStrings[0],\n                buttons: {\n                    save: langStrings[1],\n                    cancel: langStrings[2]\n                },\n                removeOnClose: true,\n                isLarge: true,\n            });\n        }).then(function(modal) {\n            modal.getRoot().on(ModalEvents.save, (e) => agreeStatement(e, modal));\n            modal.getRoot().on(ModalEvents.destroyed, () => handleRedirect());\n            modal.getRoot().on(ModalEvents.hidden, () => handleRedirect());\n            modal.getRoot().on(ModalEvents.cancel, () => handleRedirect());\n\n            modal.show();\n        }).catch(Notification.exception);\n    }).fail(Notification.exception);\n}\n\n/**\n * Listen to escape button pushed.\n * @param e\n */\nfunction escCloseListener(e) {\n    if (e.keyCode === KeyCodes.escape) {\n        handleRedirect();\n    }\n}\n\n/**\n * Handle redirect action.\n */\nfunction handleRedirect() {\n    if (self.submitted === false) {\n        window.location.replace(self.cancelurl);\n    }\n}\n\n/**\n * Submit statement agreement.\n *\n * @param e\n * @param modal\n */\nfunction agreeStatement(e, modal) {\n    const agreed = modal.getRoot().find('form input').prop('checked');\n\n    e.preventDefault();\n\n    if (agreed === false) {\n        modal.getRoot().find('[data-role=\"agreementrequired\"]').removeAttr('hidden');\n        return;\n    }\n\n    const args = {\n        'name': self.statementname,\n        'contextid': self.contextid,\n        'userid': 0,\n    };\n\n    Ajax.call([{\n        methodname: 'local_integrity_agree_statement',\n        args: args,\n        done: function () {\n            self.submitted = true;\n            document.removeEventListener('keyup', escCloseListener);\n            modal.destroy();\n        },\n        fail: function (response) {\n            Notification.exception(response);\n        }\n    }]);\n}\n\nexport {init};\n"],"file":"statement.min.js"}